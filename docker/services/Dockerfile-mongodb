FROM mongo:latest

# Create directories for data and config
RUN mkdir -p /data/db /data/configdb

# Create directory for keyfile
RUN mkdir -p /etc/mongodb

# Generate keyfile and set permissions
RUN openssl rand -base64 756 > /etc/mongodb/keyfile
RUN chown mongodb:mongodb /etc/mongodb/keyfile
RUN chmod 400 /etc/mongodb/keyfile

# Set permissions for data directories
RUN chown -R mongodb:mongodb /data/db /data/configdb

# Create directory for init script
RUN mkdir -p /docker-entrypoint-initdb.d/

# Copy initialization script
COPY ./init-mongo.sh /docker-entrypoint-initdb.d/
RUN chmod +x /docker-entrypoint-initdb.d/init-mongo.sh

# Expose MongoDB port
EXPOSE 27017

# Start MongoDB with replica set, auth, and keyFile
CMD ["mongod", "--replSet", "rs0", "--bind_ip_all", "--port", "27017", "--auth", "--keyFile", "/etc/mongodb/keyfile"]
